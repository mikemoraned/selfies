<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <style>
        .land {
            fill: #6FC480;
            stroke: #000000;
        }

        .graticule {
            fill: none;
            stroke: #777;
            stroke-opacity: .5;
            stroke-width: .5px;
        }

        .tweet.keep {
            fill: green;
            stroke: #777;
        }

        .tweet.latest {
            fill: red;
            stroke: #777;
        }

        svg {
            float: left;
        }

        #tweet_container {
            float: left;
        }
    </style>
</head>
<body>

<svg width="840" height="800">
</svg>

<div id="tweet_container"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
<script src="ngeohash.js"></script>
<script>window.twttr = (function (d, s, id) {
    var t, js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src= "https://platform.twitter.com/widgets.js";
    fjs.parentNode.insertBefore(js, fjs);
    return window.twttr || (t = { _e: [], ready: function (f) { t._e.push(f) } });
}(document, "script", "twitter-wjs"));</script>

<script>
    var ngeohash = require('ngeohash');

    var width = 840;
    var height = 800;
    var projection = d3.geo.orthographic()
            .scale(300)
            .translate([width/2, height/2])
            .clipAngle(90);

    d3.json("world110.json", function(err, world) {
        console.log("data", world);
        var land = topojson.feature(world, world.objects.land);

        var svg = d3.select("svg");
        var path = d3.geo.path()
                .projection(projection);
        var graticule = d3.geo.graticule();
        svg.append("path")
                .datum(graticule)
                .attr("class", "graticule")
                .attr("d", path);
        svg.append("path")
                .attr("d", path(land))
                .classed("land", true);

        function geohashFromTweet(tweet) {
            return ngeohash.encode(tweet.location.lat, tweet.location.lon, 3);
        }

        function featureFromTweet(tweet) {
            var geohash = geohashFromTweet(tweet);
            return featureFromGeohash(geohash);
        }

        function featureFromGeohash(geohash) {
            var bbox = ngeohash.decode_bbox(geohash);
            var minlat = bbox[0], minlon = bbox[1], maxlat = bbox[2], maxlon = bbox[3];

            return {
                type: "Feature",
                geometry: {
                    type: "Polygon",
                    properties: {},
                    coordinates: [[
                        [minlon, minlat],
                        [minlon, maxlat],
                        [maxlon, maxlat],
                        [maxlon, minlat],
                        [minlon, minlat] ]]
                }
            };
        }

        function pathFromGeohash(geohash) {
            return path(featureFromGeohash(geohash));
        }

        function showTweetSample(tweets) {
            var i = Math.floor(Math.random() * (tweets.length - 1));
            var tweet = tweets[i];

            var tweetFeature = featureFromTweet(tweet);

            d3.transition()
                    .duration(2000)
                    .each("start", function () {
                        console.log("start");
                        d3.select(".tweet.latest").remove();
                        if (window.twttr && twttr.widgets && twttr.widgets.createTweet) {
                            d3.selectAll("#tweet_container *").remove();
                            twttr.widgets.createTweet(tweet.id, document.getElementById('tweet_container'));
                        }
                    })
                    .tween("rotate", function () {
                        var p = d3.geo.centroid(tweetFeature),
                                r = d3.interpolate(projection.rotate(), [-p[0], -p[1]]);

                        return function (t) {
                            projection.rotate(r(t));
                            d3.select(".graticule").attr("d", path);
                            d3.select(".land").attr("d", path(land));
                            d3.selectAll(".tweet.keep").attr("d", pathFromGeohash);

                            d3.select(".tweet.latest").remove();
                            svg.append("path")
                                    .attr("d", path(tweetFeature))
                                    .classed("tweet", true)
                                    .classed("latest", true);
                        };
                    })
                    .transition();
        }

        function showGeoHistory(history) {
            var allGeoHashes = [];
            for (var geohash in history) {
                if (history.hasOwnProperty(geohash)) {
                    allGeoHashes.push(geohash);
                }
            }

            svg.selectAll(".tweet.keep")
                    .data(allGeoHashes)
                    .attr("d", pathFromGeohash)
                    .enter()
                    .append("path")
                    .attr("d", pathFromGeohash)
                    .classed("tweet", true)
                    .classed("keep", true);
        }

        function fetchTweetSample() {
            d3.json("/api/sample", function(e, json) {
                if (e) {
                    console.dir(e);
                }
                else
                {
                    showTweetSample(json);
                }
            })
        }

        fetchTweetSample();

        setInterval(fetchTweetSample, 5000);

        function fetchGeoHistory() {
            d3.json("/api/geohistory", function(e, json) {
                if (e) {
                    console.dir(e);
                }
                else
                {
                    showGeoHistory(json);
                }
            })
        }

        fetchGeoHistory();

        setInterval(fetchGeoHistory, 5000);
    })
</script>
</body>
</html>